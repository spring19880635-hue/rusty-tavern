<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é”ˆé½¿è½®é…’é¦† Â· é™æ—¶å°å±‹</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #0c0e1a;
      color: #e0d6c9;
      font-family: "Microsoft Yahei", sans-serif;
      overflow-x: hidden;
      height: 100vh;
      position: relative;
    }
    .container {
      position: relative;
      z-index: 2;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      text-align: center;
    }
    h1 {
      margin: 20px 0 15px;
      font-size: 1.8em;
      color: #f0e6d2;
    }
    .subtitle {
      font-size: 0.95em;
      color: #a8b2d1;
      margin-bottom: 25px;
      line-height: 1.5;
    }
    .principle {
      background: rgba(20, 25, 45, 0.6);
      border-radius: 10px;
      padding: 15px;
      margin: 20px 0;
      font-size: 0.9em;
      line-height: 1.6;
      text-align: left;
    }
    button {
      background: #5d4a7d;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 30px;
      font-size: 1em;
      cursor: pointer;
      transition: background 0.3s;
      margin: 10px;
    }
    button:hover { background: #7a62a0; }
    .hidden { display: none; }

    /* èŠå¤©å®¤æ ·å¼ */
    .chat-room {
      background: rgba(15, 20, 40, 0.8);
      border-radius: 12px;
      padding: 20px;
      margin-top: 20px;
      text-align: left;
    }
    .room-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 15px;
      color: #c0b0a0;
      font-size: 0.95em;
    }
    #messages {
      height: 200px;
      overflow-y: auto;
      background: rgba(10, 12, 25, 0.7);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 15px;
      font-size: 0.95em;
    }
    .message {
      margin-bottom: 8px;
      line-height: 1.4;
    }
    .message strong { color: #a8b2d1; }
    .message em { color: #7a82a0; }
    #msg-input {
      width: 75%;
      padding: 8px;
      background: rgba(20, 22, 40, 0.8);
      border: 1px solid #4a5070;
      color: #e0d6c9;
      border-radius: 4px;
    }
    #send-btn {
      width: 22%;
      padding: 8px;
      margin-left: 5px;
    }
    .avatar-list {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      justify-content: center;
      flex-wrap: wrap;
    }
    .avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: #3a325d;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      user-select: none;
      border: 2px solid transparent;
    }
    .avatar.selected { border: 2px solid #f0e6d2; }
  </style>
</head>
<body>
  <div class="container" id="main-view">
    <h1>ğŸ· é”ˆé½¿è½®é…’é¦†</h1>
    <p class="subtitle">ä»Šå¤œï¼Œä½ å¯ä»¥æˆä¸ºä»»ä½•äººï¼Œè¯´ä»»ä½•äº‹ã€‚<br>è¿™é‡Œæ²¡æœ‰â€œåº”è¯¥åšå¼ºâ€ï¼Œåªæœ‰â€œæˆ‘åœ¨å¬â€ã€‚</p>

    <div class="principle">
      è¿™é‡Œä¸æ˜¯é¿ä¸–çš„æ¡ƒæºï¼Œ<br>
      è€Œæ˜¯ç°å®é‡å‹ä¸‹ï¼Œä¸€ä¸ªå¯ä»¥æš‚æ—¶å¸ä¸‹èº«ä»½çš„åœ°æ–¹ã€‚
    </div>

    <button onclick="showCreateRoom()">ğŸ”® å¼€ä¸€é—´å°å±‹ï¼Œä¸æ—…äººåŒåç‰‡åˆ»</button>
    <button onclick="showBottles()">ğŸŒŠ æèµ·ä¸€ä¸ªæ¼‚æµç“¶</button>
  </div>

  <!-- åˆ›å»ºæˆ¿é—´ç•Œé¢ -->
  <div class="container hidden" id="create-room-view">
    <h2>å»ºç¯±å°å±‹</h2>
    <p style="margin:15px 0;color:#a8b2d1;">è¯·è¾“å…¥æˆ¿é—´ä¸»é¢˜ï¼ˆå¦‚â€œè¢«è£ç¬¬3å¤©â€ï¼‰</p>
    <input type="text" id="room-topic" placeholder="ä¾‹å¦‚ï¼š40å²è½¬è¡Œï¼Œæœ‰äººå—ï¼Ÿ" style="width:80%;padding:10px;margin:10px;border-radius:6px;background:#1e233c;color:#e0d6c9;border:1px solid #4a5070;">
    
    <p style="margin:15px 0;color:#a8b2d1;">é€‰æ‹©ä½ çš„ä»Šæ™šå½¢è±¡ï¼š</p>
    <div class="avatar-list" id="avatar-select"></div>

    <p style="margin:15px 0;color:#a8b2d1;">è®¾ç½®æ˜µç§°ï¼ˆéçœŸå®å§“åï¼‰ï¼š</p>
    <input type="text" id="user-nickname" placeholder="å¦‚ï¼šä¿®é’Ÿäººã€æµæµªçŒ«" style="width:80%;padding:10px;margin:10px;border-radius:6px;background:#1e233c;color:#e0d6c9;border:1px solid #4a5070;">

    <br>
    <button onclick="createRoom()">åˆ›å»ºå°å±‹</button>
    <button onclick="backToMain()">è¿”å›é…’é¦†</button>
  </div>

  <!-- èŠå¤©å®¤ç•Œé¢ -->
  <div class="container hidden" id="chat-room-view">
    <div class="chat-room">
      <div class="room-header">
        <div>å°å±‹ï¼š<span id="room-topic-display"></span></div>
        <div>â³ <span id="timer">30:00</span></div>
      </div>
      <div id="messages"></div>
      <div style="display:flex;">
        <input type="text" id="msg-input" placeholder="è¯´ç‚¹ä»€ä¹ˆå§...ï¼ˆèŠå®Œå³ç„šï¼‰">
        <button id="send-btn" onclick="sendMessage()">å‘é€</button>
      </div>
      <p style="font-size:0.85em;color:#7a82a0;margin-top:10px;">
        æœ¬å±‹30åˆ†é’Ÿåç†„ç¯ï¼Œæ‰€æœ‰è¯è¯­å°†éšçƒ›ç«æ¶ˆæ•£ã€‚
      </p>
    </div>
    <button onclick="leaveRoom()" style="background:#8b3a3a;">ç¦»å¼€å°å±‹</button>
  </div>

  <!-- æ¼‚æµç“¶ -->
  <div class="container hidden" id="bottles-view">
    <h2>å¿ƒæ²³æ¼‚æµç“¶</h2>
    <div style="background:rgba(15,20,40,0.6);padding:15px;border-radius:10px;margin:20px 0;text-align:left;">
      <div class="bottle" style="background:rgba(60,80,120,0.4);padding:10px;margin:10px 0;border-left:3px solid #8a7ca8;cursor:pointer;" 
           onclick="alert('â€œè¢«è£é‚£å¤©ï¼Œæˆ‘å‡è£…å»ä¸Šç­ï¼Œåœ¨å…¬å›­åäº†ä¸€æ•´å¤©ã€‚â€\n\nâ€”â€” ä¸€ä½åŒ¿åçš„â€œæœ«ç­åœ°é“å¸æœºâ€')">â€œè¢«è£é‚£å¤©ï¼Œæˆ‘å‡è£…å»ä¸Šç­ï¼Œåœ¨å…¬å›­åäº†ä¸€æ•´å¤©ã€‚â€</div>
      <div class="bottle" style="background:rgba(60,80,120,0.4);padding:10px;margin:10px 0;border-left:3px solid #8a7ca8;cursor:pointer;" 
           onclick="alert('â€œ40å²å­¦Pythonï¼Œä¸æ˜¯ä¸ºäº†é€†è¢­ï¼Œåªæ˜¯ä¸æƒ³è®¤è¾“ã€‚â€\n\nâ€”â€” ä¸€ä½åŒ¿åçš„â€œä¿®é’Ÿäººâ€')">â€œ40å²å­¦Pythonï¼Œä¸æ˜¯ä¸ºäº†é€†è¢­ï¼Œåªæ˜¯ä¸æƒ³è®¤è¾“ã€‚â€</div>
    </div>
    <button onclick="backToMain()">è¿”å›é…’é¦†</button>
  </div>

  <script>
    // ========== ğŸ”‘ è¯·åœ¨ Vercel ç¯å¢ƒå˜é‡ä¸­è®¾ç½®ä»¥ä¸‹é…ç½® ==========
    // åœ¨ Vercel é¡¹ç›®è®¾ç½®ä¸­æ·»åŠ ï¼š
    // FIREBASE_API_KEY
    // FIREBASE_AUTH_DOMAIN
    // FIREBASE_DATABASE_URL
    // FIREBASE_PROJECT_ID
    // FIREBASE_STORAGE_BUCKET
    // FIREBASE_MESSAGING_SENDER_ID
    // FIREBASE_APP_ID
    // =============================================================

    // ä»ç¯å¢ƒå˜é‡è·å–é…ç½®ï¼ˆVercel æ„å»ºæ—¶ä¼šæ³¨å…¥ï¼‰
    const firebaseConfig = {
      apiKey: typeof process !== 'undefined' ? process.env.FIREBASE_API_KEY : window.FIREBASE_API_KEY || '{{FIREBASE_API_KEY}}',
      authDomain: typeof process !== 'undefined' ? process.env.FIREBASE_AUTH_DOMAIN : window.FIREBASE_AUTH_DOMAIN || '{{FIREBASE_AUTH_DOMAIN}}',
      databaseURL: typeof process !== 'undefined' ? process.env.FIREBASE_DATABASE_URL : window.FIREBASE_DATABASE_URL || '{{FIREBASE_DATABASE_URL}}',
      projectId: typeof process !== 'undefined' ? process.env.FIREBASE_PROJECT_ID : window.FIREBASE_PROJECT_ID || '{{FIREBASE_PROJECT_ID}}',
      storageBucket: typeof process !== 'undefined' ? process.env.FIREBASE_STORAGE_BUCKET : window.FIREBASE_STORAGE_BUCKET || '{{FIREBASE_STORAGE_BUCKET}}',
      messagingSenderId: typeof process !== 'undefined' ? process.env.FIREBASE_MESSAGING_SENDER_ID : window.FIREBASE_MESSAGING_SENDER_ID || '{{FIREBASE_MESSAGING_SENDER_ID}}',
      appId: typeof process !== 'undefined' ? process.env.FIREBASE_APP_ID : window.FIREBASE_APP_ID || '{{FIREBASE_APP_ID}}'
    };

    // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰é…ç½®éƒ½å·²è®¾ç½®
    const hasValidConfig = Object.values(firebaseConfig).every(value => 
      value && !value.startsWith('{{') && value !== 'undefined' && value !== ''
    );

    if (!hasValidConfig) {
      console.warn("âš ï¸ Firebase é…ç½®æœªå®Œå…¨è®¾ç½®ï¼Œè¯·åœ¨ Vercel ç¯å¢ƒå˜é‡ä¸­é…ç½®ã€‚");
      // ä¸åˆå§‹åŒ– Firebaseï¼Œåç»­åŠŸèƒ½ä¼šæ£€æŸ¥ database æ˜¯å¦å­˜åœ¨
    } else {
      firebase.initializeApp(firebaseConfig);
    }

    const database = hasValidConfig ? firebase.database() : null;

    // ========== å…¨å±€çŠ¶æ€ ==========
    let currentRoomId = null;
    let currentUser = null;
    let timerInterval = null;
    let roomRef = null;
    let myUserId = null;

    // ========== å¡é€šå¤´åƒ ==========
    const avatars = ['ğŸ•°ï¸','ğŸš‡','ğŸ“¬','ğŸ”§','ğŸ“œ','ğŸŒ±','ğŸ§­','ğŸ•¯ï¸','ğŸ“¦','ğŸ“š','â›µ','ğŸªµ'];

    // ========== åˆå§‹åŒ–å¤´åƒé€‰æ‹© ==========
    function initAvatarSelect() {
      const container = document.getElementById('avatar-select');
      container.innerHTML = '';
      avatars.forEach(emoji => {
        const div = document.createElement('div');
        div.className = 'avatar';
        div.textContent = emoji;
        div.onclick = () => {
          document.querySelectorAll('.avatar').forEach(el => el.classList.remove('selected'));
          div.classList.add('selected');
          div.dataset.selected = emoji;
        };
        container.appendChild(div);
      });
      if (container.children[0]) {
        container.children[0].classList.add('selected');
        container.children[0].dataset.selected = avatars[0];
      }
    }

    // ========== è§†å›¾åˆ‡æ¢ ==========
    function showCreateRoom() {
      document.getElementById('main-view').classList.add('hidden');
      document.getElementById('create-room-view').classList.remove('hidden');
      initAvatarSelect();
    }

    function showBottles() {
      document.getElementById('main-view').classList.add('hidden');
      document.getElementById('bottles-view').classList.remove('hidden');
    }

    function backToMain() {
      document.getElementById('create-room-view').classList.add('hidden');
      document.getElementById('bottles-view').classList.add('hidden');
      document.getElementById('chat-room-view').classList.add('hidden');
      document.getElementById('main-view').classList.remove('hidden');
      cleanup();
    }

    function cleanup() {
      if (timerInterval) clearInterval(timerInterval);
      if (roomRef && database) {
        roomRef.off();
        if (myUserId) {
          roomRef.child('users').child(myUserId).remove();
        }
      }
      currentRoomId = null;
      currentUser = null;
      myUserId = null;
    }

    // ========== å°å±‹å®ˆåˆ™ ==========
    function showHouseRules() {
      const rules = `ğŸ· é”ˆé½¿è½®é…’é¦† Â· å°å±‹å®ˆåˆ™

è¿™é‡Œä¸æ˜¯è§£å†³é—®é¢˜çš„åœ°æ–¹ï¼Œ
è€Œæ˜¯å…è®¸è„†å¼±å­˜åœ¨çš„ç©ºé—´ã€‚

è¯·éµå®ˆï¼š
1. ä¸è¯„åˆ¤ã€ä¸è¯´æ•™ã€ä¸è¿½é—®éšç§ï¼›
2. å¯å€¾è¯‰ï¼Œä½†ä¸æ”»å‡»ä»–äººï¼›
3. è‹¥æ„Ÿåˆ°ä¸é€‚ï¼Œè¯·å®‰é™ç¦»å¼€ï¼›
4. æ‰€æœ‰è¯è¯­ï¼Œ30åˆ†é’Ÿåéšçƒ›ç«æ¶ˆæ•£ã€‚

ä½ æ— éœ€åšå¼ºï¼Œ
åªéœ€çœŸå®ã€‚

â€”â€” ç‚¹â€œç¡®å®šâ€å³è§†ä¸ºç†è§£å¹¶å°Šé‡æ­¤ç©ºé—´`;
      if (confirm(rules)) {
        proceedToChat();
      } else {
        backToMain();
      }
    }

    // ========== åˆ›å»ºæˆ¿é—´ ==========
    function createRoom() {
      if (!database) {
        alert("âš ï¸ Firebase æœªé…ç½®ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æˆ–æ£€æŸ¥éƒ¨ç½²è®¾ç½®ã€‚");
        return;
      }
      const topic = document.getElementById('room-topic').value.trim();
      const nickname = document.getElementById('user-nickname').value.trim();
      const avatarEl = document.querySelector('.avatar.selected');
      const avatar = avatarEl ? avatarEl.dataset.selected : avatars[0];

      if (!topic || !nickname) {
        alert("è¯·å¡«å†™æˆ¿é—´ä¸»é¢˜å’Œæ˜µç§°");
        return;
      }

      currentRoomId = Math.random().toString(36).substr(2, 8);
      currentUser = { nickname, avatar };
      showHouseRules();
    }

    function proceedToChat() {
      document.getElementById('create-room-view').classList.add('hidden');
      document.getElementById('chat-room-view').classList.remove('hidden');
      document.getElementById('room-topic-display').textContent = document.getElementById('room-topic').value;
      joinRoom();
    }

    // ========== åŠ å…¥æˆ¿é—´ï¼ˆå«5äººé™åˆ¶ï¼‰ ==========
    function joinRoom() {
      if (!database) {
        alert("âš ï¸ Firebase æœªé…ç½®ï¼Œæ— æ³•åŠ å…¥æˆ¿é—´ã€‚");
        backToMain();
        return;
      }
      roomRef = database.ref(`rooms/${currentRoomId}`);
      
      roomRef.once('value', (snapshot) => {
        if (!snapshot.exists()) {
          roomRef.set({ createdAt: Date.now() });
        }
      });

      myUserId = database.ref().push().key;
      const usersRef = roomRef.child('users');

      usersRef.child(myUserId).set({
        nickname: currentUser.nickname,
        avatar: currentUser.avatar,
        joinedAt: firebase.database.ServerValue.TIMESTAMP
      });

      usersRef.on('value', (snapshot) => {
        const count = snapshot.numChildren();
        if (count > 5) {
          usersRef.child(myUserId).remove();
          alert("å°å±‹å·²æ»¡ï¼ˆæœ€å¤š5äººï¼‰ï¼Œè¯·ç¨åå†è¯•æˆ–åˆ›å»ºæ–°å±‹ã€‚");
          backToMain();
          return;
        }
        const topic = document.getElementById('room-topic').value;
        document.getElementById('room-topic-display').textContent = `${topic} (${count}/5)`;
      });

      roomRef.child('messages').on('child_added', (snapshot) => {
        const msg = snapshot.val();
        addMessageToUI(msg);
      });

      setTimeout(() => {
        roomRef.child('messages').push({
          nickname: currentUser.nickname,
          avatar: currentUser.avatar,
          text: `${currentUser.avatar} ${currentUser.nickname} è¿›å…¥äº†å°å±‹`,
          time: Date.now(),
          system: true
        });
      }, 300);

      startTimer(30 * 60);
    }

    // ========== èŠå¤©åŠŸèƒ½ ==========
    function sendMessage() {
      if (!database) return;
      const input = document.getElementById('msg-input');
      const text = input.value.trim();
      if (!text) return;

      roomRef.child('messages').push({
        nickname: currentUser.nickname,
        avatar: currentUser.avatar,
        text: text,
        time: Date.now()
      });
      input.value = '';
    }

    function addMessageToUI(msg) {
      const messagesDiv = document.getElementById('messages');
      const div = document.createElement('div');
      div.className = 'message';
      if (msg.system) {
        div.innerHTML = `<em>${msg.text}</em>`;
      } else {
        div.innerHTML = `<strong>${msg.avatar} ${msg.nickname}:</strong> ${msg.text}`;
      }
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // ========== å€’è®¡æ—¶ ==========
    function startTimer(seconds) {
      let total = seconds;
      updateTimerDisplay(total);
      timerInterval = setInterval(() => {
        total--;
        updateTimerDisplay(total);
        if (total <= 0) {
          endRoom();
        }
      }, 1000);
    }

    function updateTimerDisplay(totalSeconds) {
      const mins = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
      const secs = (totalSeconds % 60).toString().padStart(2, '0');
      document.getElementById('timer').textContent = `${mins}:${secs}`;
    }

    function endRoom() {
      clearInterval(timerInterval);
      alert("å°å±‹å·²ç†„ç¯ï¼Œæ„Ÿè°¢ä½ çš„é™ªä¼´ã€‚\næ‰€æœ‰è¯è¯­å·²éšçƒ›ç«æ¶ˆæ•£ã€‚");
      backToMain();
    }

    // ========== ç¦»å¼€æˆ¿é—´ ==========
    function leaveRoom() {
      if (roomRef && currentUser && database) {
        if (myUserId) {
          roomRef.child('users').child(myUserId).remove();
        }
        roomRef.child('messages').push({
          nickname: currentUser.nickname,
          avatar: currentUser.avatar,
          text: `${currentUser.avatar} ${currentUser.nickname} ç¦»å¼€äº†å°å±‹`,
          time: Date.now(),
          system: true
        });
      }
      backToMain();
    }

    // ========== å›è½¦å‘é€ ==========
    document.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !document.getElementById('chat-room-view').classList.contains('hidden')) {
        sendMessage();
      }
    });
  </script>
</body>
</html>